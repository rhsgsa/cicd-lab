= 3. CI/CD OpenShift Build

A CICD pipeline has been provisioned in your OpenShift namespace. This section is to showcase the integration of CICD with Microshift. Let's take a look at the pipeline in the OpenShift Console.

[start=1]

. Login to the {CONSOLE_URL}[OpenShift Console,window=console] in a new browser tab - select the `ldap_provider` and enter your assigned username and password
+
image::auth_providers.png[Authentication providers]

. Select the %USER% project / Pipelines / `build-and-deploy`
+
image::select_pipeline.png[Select pipeline]

. The pipeline clones from a Java source git repo, builds the application, creates a container image, pushes the container image to an image registry, and deploys the image to the Micorshift VM
+
image::pipeline.png[Pipeline]

. If you wish to examine the artifacts that were used to deploy the pipeline, you can look through the files in the {GIT_URL}/%USER%/pipeline[pipline git repo,window=git]

== Initial Build
include::_attributes.adoc[]

In this module, we will trigger the pipeline for the first time. We will do this by triggering a webhook from the application source git repo.

. Open the {GIT_URL}/%USER%/sample-app[application source git repo,window=git] in a new browser tab

. Sign in using your assigned username and password
+
image::login_to_gitea.png[Login to gitea]

. A webhook has been configured in this git repo to trigger the pipeline - examine the webhook by selecting menu:Settings[Webhooks > `\http://el-build-and-deploy...`]
+
image::webhook.png[Webhook]

. Trigger the webhook by scrolling to the bottom of the page and clicking on Test Delivery
+
image::test_delivery.png[Test Delivery]

. Examine the {CONSOLE_URL}/pipelines/ns/%USER%/pipeline-runs[PipelineRuns screen in the OpenShift Console,window=console] - you should see a new pipeline run running

. Wait for the pipeline run to fail due to security vulnerabilities that was flagged out by Advanced Cluster Security
. Continuous scanning and assurance can be achieved by integrating CI/CD Pipelines and Image Registries with the Red Hat Advanced Cluster Security for Kubernetes 
+
image::acs-scan-failure.png[ACS Scan Failed]

. Configure your user name and email for Git in Dev Spaces. For instance
+
 $ git config --global user.name "user100"
 $ git config --global user.email "user100@example.com"

. Git clone the `sample-app` repository into Dev Spaces, i.e. `+git clone+` https://{GIT_URL}/%USER%/sample-app.git

. Edit the Dockerfile
+
image::edit-dockerfile-devspaces.png[Edit DockerFile]

. Change the base image in line 1 from `+registry.access.redhat.com/ubi8/ubi:8.8-1067.1697633337+` to `+registry.access.redhat.com/ubi8/ubi:latest+`
. The latest UBI image will contain the fix for the CVE that was detected earlier on an older UBI image
+
image::edit-dockerfile-devspaces-to-latest.png[Edit DockerFile Image to Latest]

. Commit the change
+
image::commit_changes_devspaces.png[Commit Change]

. Click Yes
+
image::stage_commit_changes_devspaces.png[Stage and Commit Change]

. Sync and Push the change
+
image::sync_changes_devspaces.png[Sync and Push Change]

. Key in user name
+
image::key_in_git_username.png[Key in Username]

. Key in password
+
image::key_in_git_password.png[Key in Password]

. Switch back to the OpenShift Console - a new pipeline run should have been triggered by the webhook

. Wait for the pipeline run to complete

. Test that the application is running properly by accessing the DevSpaces terminal and executing the following command: 
+
 $ curl microshift-vmiservice.%USER%.svc.cluster.local:8081

. You should be able to see something similar in the output on your terminal:
+
 simpleweb-b4975f85f-gdlvr: Hello there World

. Next, proceed to make a change in the `main.go` file

. Change the greeting in line 26 from `Hello` to `Good Morning`
+
image::update_main_go.png[Update main.go]

. Follow the same steps as before to commit and push the change to the git repository

. Switch back to the OpenShift Console - a new pipeline run should have been triggered by the webhook

. Wait for the pipeline run to complete
+
image::final-working-pipeline.png[Complete Working Pipeline]

. Once the pipelines has been completed, you can repeat the curl statement on the DevSpaces console by executing the following command: 
+
 $ curl microshift-vmiservice.%USER%.svc.cluster.local:8081

. Now you should be able to see the new output on your terminal:
+
 simpleweb-b4975f85f-gdlvr: Good Morning World

== 4.1. Conclusion
You have successfully compiled and re-built your application with the reflected change in source code. You are now done with the last part of the hands-on workshop!
